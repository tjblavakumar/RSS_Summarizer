{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="bg-success bg-opacity-10 rounded p-3 mb-4 d-flex justify-content-between align-items-center">
                <h1 class="fw-bold mb-0" style="font-size: 24px;">RSS News Summary</h1>
                <div class="d-flex align-items-center gap-3">
                    <a href="{{ url_for('generate_markdown') }}" class="btn btn-outline-primary btn-sm">Download
                        Markdown</a>
                    <a href="{{ url_for('generate_html') }}" class="btn btn-outline-success btn-sm">Download HTML</a>
                    {% if last_refresh %}
                    <div class="fw-bold" style="font-size: 14px;">Generated: {{ last_refresh.strftime('%Y-%m-%d
                        %H:%M:%S') }}</div>
                    {% endif %}
                </div>
            </div>

            {% if articles %}
            <div class="row">
                <!-- Summary Section - Half Page Width -->
                <div class="col-md-6 col-lg-5 mb-4">
                    <div class="card sticky-top" style="top: 20px;">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Summary</h5>

                            <!-- Total Articles -->
                            <div class="mb-3 p-3 bg-primary bg-opacity-10 rounded text-center">
                                <h3 class="mb-0">{{ total_articles }}</h3>
                                <small class="text-muted">Total Articles</small>
                            </div>

                            <!-- Category Breakdown with Links -->
                            <h6 class="mt-4 mb-3 fw-bold">Articles by Category</h6>
                            <div class="list-group">
                                {% for category in categories %}
                                {% if category.name in category_stats %}
                                <a href="#category-{{ category.name | slugify }}"
                                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                    style="border-left: 4px solid {{ category.color }};">
                                    <span>{{ category.name }}</span>
                                    <span class="badge rounded-pill" style="background-color: {{ category.color }};">
                                        {{ category_stats[category.name] }}
                                    </span>
                                </a>
                                {% endif %}
                                {% endfor %}

                                {% set uncategorized_count = articles | rejectattr('category_name') | list | length %}
                                {% if uncategorized_count > 0 %}
                                <a href="#category-uncategorized"
                                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                    style="border-left: 4px solid #6c757d;">
                                    <span>Uncategorized</span>
                                    <span class="badge rounded-pill bg-secondary">
                                        {{ uncategorized_count }}
                                    </span>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Articles Section - Half Page Width -->
                <div class="col-md-6 col-lg-7">
                    {% set ns = namespace(processed_categories=[]) %}
                    {% for category in categories %}
                    {% if category.name in category_stats %}
                    {% set category_articles = articles | selectattr('category_name', 'equalto', category.name) | list
                    %}
                    {% if category_articles %}

                    <!-- Category Section Header -->
                    <div id="category-{{ category.name | slugify }}" class="mb-4 pb-2 border-bottom"
                        style="border-color: {{ category.color }} !important; border-width: 3px !important;">
                        <h2 class="mb-0" style="color: {{ category.color }}; font-size: 1.5em;">
                            {{ category.name }}
                        </h2>
                    </div>

                    <!-- Articles in this Category -->
                    {% for article in category_articles %}
                    <div class="mb-4 pb-3 border-bottom">
                        <h3 class="mb-2" style="font-size: 1.2em; font-weight: 600;">
                            <a href="{{ article.url }}" target="_blank" class="text-decoration-none text-primary">
                                [{{ article.feed.name if article.feed else 'Unknown' }}] {{ article.title }}
                            </a>
                        </h3>

                        <div class="text-muted mb-3" style="font-size: 0.9em; font-style: italic;">
                            Author: {{ article.author or 'Unknown' }} | Published: {{
                            article.published_date.strftime('%Y-%m-%d %H:%M') }}
                        </div>

                        {% if article.summary %}
                        <div class="mb-3">
                            <div class="summary-content">
                                {% for line in article.summary.split('\n') %}
                                {% if line.strip().startswith('**') %}
                                <h5 class="mt-3 mb-2 fw-bold">{{ line.replace('**', '').replace(':', '') }}</h5>
                                {% elif line.strip().startswith('•') %}
                                <div class="d-flex mb-1">
                                    <span class="me-2">•</span>
                                    <span>{{ line.strip()[1:].strip() }}</span>
                                </div>
                                {% elif line.strip().startswith('> "') %}
                                <figure class="bg-light p-3 border-start border-4 border-primary rounded mb-2">
                                    <blockquote class="blockquote mb-0" style="font-size: 0.95em;">
                                        <p class="mb-0">{{ line.strip()[2:-1] }}</p>
                                    </blockquote>
                                </figure>
                                {% elif line.strip() %}
                                <p class="mb-2">{{ line.strip() }}</p>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Action Toolbar -->
                        <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge" style="background-color: {{ category.color }}; color: white;">
                                    {{ category.name }}
                                </span>
                                {% if article.relevancy_score is not none %}
                                <span class="badge bg-light text-dark border" title="Relevancy Score">
                                    {{ article.relevancy_score }}%
                                </span>
                                {% endif %}
                                <a href="{{ article.url }}" target="_blank" class="btn btn-sm btn-outline-secondary"
                                    style="border: none;">
                                    Read Original
                                </a>
                            </div>

                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-sm btn-outline-primary border-0"
                                    onclick="editSummary('{{ article.id }}')">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <div class="vr mx-1"></div>
                                <button
                                    class="btn btn-sm btn-outline-success border-0 {% if article.user_feedback == 1 %}active{% endif %}"
                                    onclick="rateArticle('{{ article.id }}', 1)" id="like-{{ article.id }}">
                                    <i
                                        class="bi bi-hand-thumbs-up{% if article.user_feedback == 1 %}-fill{% endif %}"></i>
                                </button>
                                <button
                                    class="btn btn-sm btn-outline-danger border-0 {% if article.user_feedback == -1 %}active{% endif %}"
                                    onclick="rateArticle('{{ article.id }}', -1)" id="dislike-{{ article.id }}">
                                    <i
                                        class="bi bi-hand-thumbs-down{% if article.user_feedback == -1 %}-fill{% endif %}"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden textarea for raw summary content to populate modal -->
                    <textarea id="raw-summary-{{ article.id }}" style="display: none;">{{ article.summary }}</textarea>
                    {% endfor %}
                    {% set _ = ns.processed_categories.append(category.name) %}
                    {% endif %}
                    {% endif %}
                    {% endfor %}

                    <!-- Uncategorized Articles -->
                    {% set uncategorized = articles | rejectattr('category_name') | list %}
                    {% if uncategorized %}
                    <div id="category-uncategorized" class="mb-4 pb-2 border-bottom"
                        style="border-width: 3px !important;">
                        <h2 class="mb-0" style="font-size: 1.5em;">Uncategorized</h2>
                    </div>

                    {% for article in uncategorized %}
                    <div class="mb-4 pb-3 border-bottom">
                        <h3 class="mb-2" style="font-size: 1.2em; font-weight: 600;">
                            <a href="{{ article.url }}" target="_blank" class="text-decoration-none text-primary">
                                [{{ article.feed.name if article.feed else 'Unknown' }}] {{ article.title }}
                            </a>
                        </h3>

                        <div class="text-muted mb-3" style="font-size: 0.9em; font-style: italic;">
                            Author: {{ article.author or 'Unknown' }} | Published: {{
                            article.published_date.strftime('%Y-%m-%d %H:%M') }}
                        </div>

                        {% if article.summary %}
                        <div class="mb-3">
                            <div class="summary-content">
                                {% for line in article.summary.split('\n') %}
                                {% if line.strip().startswith('**') %}
                                <h5 class="mt-3 mb-2 fw-bold">{{ line.replace('**', '').replace(':', '') }}</h5>
                                {% elif line.strip().startswith('•') %}
                                <div class="d-flex mb-1">
                                    <span class="me-2">•</span>
                                    <span>{{ line.strip()[1:].strip() }}</span>
                                </div>
                                {% elif line.strip().startswith('> "') %}
                                <figure class="bg-light p-3 border-start border-4 border-primary rounded mb-2">
                                    <blockquote class="blockquote mb-0" style="font-size: 0.95em;">
                                        <p class="mb-0">{{ line.strip()[2:-1] }}</p>
                                    </blockquote>
                                </figure>
                                {% elif line.strip() %}
                                <p class="mb-2">{{ line.strip() }}</p>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top">
                            <div class="d-flex align-items-center gap-2">
                                {% if article.relevancy_score is not none %}
                                <span class="badge bg-light text-dark border" title="Relevancy Score">
                                    {{ article.relevancy_score }}%
                                </span>
                                {% endif %}
                                <a href="{{ article.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    Read Original
                                </a>
                            </div>

                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-sm btn-outline-primary border-0"
                                    onclick="editSummary('{{ article.id }}')">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <div class="vr mx-1"></div>
                                <button
                                    class="btn btn-sm btn-outline-success border-0 {% if article.user_feedback == 1 %}active{% endif %}"
                                    onclick="rateArticle('{{ article.id }}', 1)" id="like-{{ article.id }}">
                                    <i
                                        class="bi bi-hand-thumbs-up{% if article.user_feedback == 1 %}-fill{% endif %}"></i>
                                </button>
                                <button
                                    class="btn btn-sm btn-outline-danger border-0 {% if article.user_feedback == -1 %}active{% endif %}"
                                    onclick="rateArticle('{{ article.id }}', -1)" id="dislike-{{ article.id }}">
                                    <i
                                        class="bi bi-hand-thumbs-down{% if article.user_feedback == -1 %}-fill{% endif %}"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden textarea for raw summary content to populate modal -->
                    <textarea id="raw-summary-{{ article.id }}" style="display: none;">{{ article.summary }}</textarea>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                <h4>No articles found</h4>
                <p>Add some RSS feeds and topics in the Admin panel, then click "Refresh News" to get started.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>


    // Smooth scroll to category sections
    document.querySelectorAll('a[href^="#category-"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const target = document.getElementById(targetId);
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Edit Summary Modal Logic
    let currentArticleId = null;

    function editSummary(articleId) {
        currentArticleId = articleId;
        const rawSummary = document.getElementById(`raw-summary-${articleId}`).value;
        document.getElementById('editSummaryText').value = rawSummary;
        const editModal = new bootstrap.Modal(document.getElementById('editSummaryModal'));
        editModal.show();
    }

    function saveSummary() {
        if (!currentArticleId) return;

        const newSummary = document.getElementById('editSummaryText').value;

        fetch(`/update_summary/${currentArticleId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ summary: newSummary })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Reload to show formatted changes
                } else {
                    alert('Error updating summary: ' + data.message);
                }
            });
    }

    // Feedback Logic
    function rateArticle(articleId, feedback) {
        const likeBtn = document.getElementById(`like-${articleId}`);
        const dislikeBtn = document.getElementById(`dislike-${articleId}`);

        // Toggle logic: if clicking active button, remove feedback (set to 0)
        let newFeedback = feedback;
        if ((feedback === 1 && likeBtn.classList.contains('active')) ||
            (feedback === -1 && dislikeBtn.classList.contains('active'))) {
            newFeedback = 0;
        }

        fetch(`/rate_article/${articleId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ feedback: newFeedback })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI visually without reload
                    likeBtn.classList.remove('active', 'btn-success');
                    likeBtn.classList.add('btn-outline-success');
                    likeBtn.querySelector('i').classList.replace('bi-hand-thumbs-up-fill', 'bi-hand-thumbs-up');

                    dislikeBtn.classList.remove('active', 'btn-danger');
                    dislikeBtn.classList.add('btn-outline-danger');
                    dislikeBtn.querySelector('i').classList.replace('bi-hand-thumbs-down-fill', 'bi-hand-thumbs-down');

                    if (newFeedback === 1) {
                        likeBtn.classList.add('active', 'btn-success');
                        likeBtn.classList.remove('btn-outline-success');
                        likeBtn.querySelector('i').classList.replace('bi-hand-thumbs-up', 'bi-hand-thumbs-up-fill');
                    } else if (newFeedback === -1) {
                        dislikeBtn.classList.add('active', 'btn-danger');
                        dislikeBtn.classList.remove('btn-outline-danger');
                        dislikeBtn.querySelector('i').classList.replace('bi-hand-thumbs-down', 'bi-hand-thumbs-down-fill');
                    }
                } else {
                    alert('Error submitting feedback: ' + data.message);
                }
            });
    }
</script>

<!-- Edit Summary Modal -->
<div class="modal fade" id="editSummaryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Summary</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea id="editSummaryText" class="form-control" rows="15"
                    style="font-family: monospace;"></textarea>
                <div class="form-text text-muted mt-2">
                    Start lines with <code>**</code> for headers, <code>•</code> for bullets, and <code>> "</code> for
                    quotes.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSummary()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}