{% extends "admin_base.html" %}

{% block title %}Scheduler Settings{% endblock %}

{% block admin_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2>RSS Summary Scheduler</h2>
            
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    <div class="alert alert-success">
                        {% for message in messages %}
                            {{ message }}
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}
            
            <div class="card">
                <div class="card-header">
                    <h5>Current Schedule Status</h5>
                </div>
                <div class="card-body">
                    <p><strong>Status:</strong> 
                        {% if is_running %}
                            <span class="badge bg-success">Running</span>
                        {% else %}
                            <span class="badge bg-danger">Stopped</span>
                        {% endif %}
                    </p>
                    <p><strong>Next Run:</strong> 
                        {% if next_run %}
                            {{ next_run.strftime('%Y-%m-%d %H:%M:%S %Z') }}
                        {% else %}
                            Not scheduled
                        {% endif %}
                    </p>
                    <div class="mt-3">
                        <a href="{{ url_for('run_scheduler_now') }}" class="btn btn-success">Run Now</a>
                    </div>

                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h5>Update Schedule</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('update_schedule') }}">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="frequency" class="form-label">Frequency</label>
                                <select class="form-select" id="frequency" name="frequency" onchange="updateScheduleOptions()">
                                    <option value="daily">Daily</option>
                                    <option value="hourly">Every N Hours</option>
                                    <option value="weekdays">Weekdays Only</option>
                                    <option value="weekly">Weekly</option>
                                </select>
                            </div>
                            <div class="col-md-3" id="time-section">
                                <label for="time" class="form-label">Time (24-hour format)</label>
                                <input type="time" class="form-control" id="time" name="time" value="09:00">
                            </div>
                            <div class="col-md-3" id="interval-section" style="display:none;">
                                <label for="interval" class="form-label">Every N Hours</label>
                                <select class="form-select" id="interval" name="interval">
                                    <option value="1">1 hour</option>
                                    <option value="2">2 hours</option>
                                    <option value="3">3 hours</option>
                                    <option value="6">6 hours</option>
                                    <option value="12">12 hours</option>
                                </select>
                            </div>
                            <div class="col-md-3" id="weekday-section" style="display:none;">
                                <label for="weekday" class="form-label">Day of Week</label>
                                <select class="form-select" id="weekday" name="weekday">
                                    <option value="0">Sunday</option>
                                    <option value="1">Monday</option>
                                    <option value="2">Tuesday</option>
                                    <option value="3">Wednesday</option>
                                    <option value="4">Thursday</option>
                                    <option value="5">Friday</option>
                                    <option value="6">Saturday</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button type="submit" class="btn btn-primary">Update Schedule</button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <small class="text-muted" id="cron-preview">Cron expression: 0 9 * * *</small>
                            </div>
                        </div>
                    </form>
                    
                    <script>
                    function updateScheduleOptions() {
                        const frequency = document.getElementById('frequency').value;
                        const timeSection = document.getElementById('time-section');
                        const intervalSection = document.getElementById('interval-section');
                        const weekdaySection = document.getElementById('weekday-section');
                        const cronPreview = document.getElementById('cron-preview');
                        
                        // Hide all sections first
                        timeSection.style.display = 'none';
                        intervalSection.style.display = 'none';
                        weekdaySection.style.display = 'none';
                        
                        // Show relevant sections and update cron preview
                        switch(frequency) {
                            case 'daily':
                                timeSection.style.display = 'block';
                                cronPreview.textContent = 'Cron expression: 0 9 * * *';
                                break;
                            case 'hourly':
                                intervalSection.style.display = 'block';
                                cronPreview.textContent = 'Cron expression: 0 */6 * * *';
                                break;
                            case 'weekdays':
                                timeSection.style.display = 'block';
                                cronPreview.textContent = 'Cron expression: 0 9 * * 1-5';
                                break;
                            case 'weekly':
                                timeSection.style.display = 'block';
                                weekdaySection.style.display = 'block';
                                cronPreview.textContent = 'Cron expression: 0 9 * * 1';
                                break;
                        }
                    }
                    
                    // Update cron preview when time or interval changes
                    document.getElementById('time').addEventListener('change', updateCronPreview);
                    document.getElementById('interval').addEventListener('change', updateCronPreview);
                    document.getElementById('weekday').addEventListener('change', updateCronPreview);
                    
                    function updateCronPreview() {
                        const frequency = document.getElementById('frequency').value;
                        const time = document.getElementById('time').value;
                        const interval = document.getElementById('interval').value;
                        const weekday = document.getElementById('weekday').value;
                        const cronPreview = document.getElementById('cron-preview');
                        
                        let [hour, minute] = time ? time.split(':') : ['9', '0'];
                        
                        switch(frequency) {
                            case 'daily':
                                cronPreview.textContent = `Cron expression: ${minute} ${hour} * * *`;
                                break;
                            case 'hourly':
                                cronPreview.textContent = `Cron expression: 0 */${interval} * * *`;
                                break;
                            case 'weekdays':
                                cronPreview.textContent = `Cron expression: ${minute} ${hour} * * 1-5`;
                                break;
                            case 'weekly':
                                cronPreview.textContent = `Cron expression: ${minute} ${hour} * * ${weekday}`;
                                break;
                        }
                    }
                    </script>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h5>Information</h5>
                </div>
                <div class="card-body">
                    <ul>
                        <li>The RSS summary will run automatically every day at the scheduled time (Pacific Time)</li>
                        <li>The scheduler runs in the background and processes all active feeds and topics</li>
                        <li>You can still manually refresh news using the "Refresh News" button on the dashboard</li>
                        <li>The scheduler will automatically clean up articles older than 24 hours</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}